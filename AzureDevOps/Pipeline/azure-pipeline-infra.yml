trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - AzureDevOps/*  # Ignore changes in this folder

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: 'secrer-santa-secretsanta-f4465ce8-e6e6-4c46-b979-67aea42c5fb1'  # Update with your service connection
  terraformVersion: '1.6.0'
  terraformWorkingDirectory: 'AzureDevOps/Infrastructure/azure-vm'  # âœ… Updated path

stages:
- stage: Deploy_VM
  jobs:
  - job: Terraform
    steps:

    # ğŸ” Authenticate to Azure
    - task: AzureCLI@2
      displayName: 'ğŸ” Azure Login'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logged in to Azure:"
          az account show

    # ğŸ“¦ Install Terraform
    - script: |
        echo "â¬‡ï¸ Installing Terraform $(terraformVersion)..."
        curl -sLo terraform.zip https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform -version
      displayName: 'ğŸ“¦ Install Terraform CLI'

    # ğŸ”§ Initialize Terraform
    - script: |
        echo "ğŸ“‚ Changing to Terraform directory..."
        cd $(terraformWorkingDirectory)

        echo "ğŸ“ Initializing Terraform..."
        terraform init
      workingDirectory: $(terraformWorkingDirectory)
      displayName: 'ğŸ”§ Terraform Init'

    # âœ… Validate Terraform files
    - script: |
        echo "ğŸ” Validating Terraform..."
        terraform validate
      workingDirectory: $(terraformWorkingDirectory)
      displayName: 'âœ… Terraform Validate'

    # ğŸ”‘ Securely Pass Subscription and Authentication Variables
    - script: |
        echo "ğŸ§  Planning Terraform..."
        terraform plan \
          -var "subscription_id=$(subscription_id)" \
          -var "client_id=$(client_id)" \
          -var "client_secret=$(client_secret)" \
          -var "tenant_id=$(tenant_id)" \
          -var "admin_password=$(admin_password)" \
          -var-file="terraform.tfvars" \
          -out=tfplan.out
      workingDirectory: $(terraformWorkingDirectory)
      displayName: 'ğŸ“ Terraform Plan'
      env:
        client_secret: $(client_secret)  # ğŸ” Ensure secrets are passed securely
        admin_password: $(admin_password)

    # ğŸš€ Apply Terraform Changes
    - script: |
        echo "ğŸš€ Applying Terraform..."
        terraform apply -auto-approve tfplan.out
      workingDirectory: $(terraformWorkingDirectory)
      displayName: 'ğŸš€ Terraform Apply'
      env:
        client_secret: $(client_secret)  # ğŸ” Ensure secrets are passed securely
        admin_password: $(admin_password)
